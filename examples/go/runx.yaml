actions:
  - id: lint
    desc: Run golangci-lint
    type: run
    shell:
      pwd: pwd
      gopath: go env GOPATH
      gocache: go env GOCACHE
    cmd: >
      --rm
      {{if .IsTTY}}-t{{end}}
      -v {{sh "pwd"}}:/app
      -v {{sh "gopath"}}/pkg:/go/pkg
      -v {{sh "gocache"}}:/cache/go
      -e GOFLAGS=-buildvcs=false
      -e GOCACHE=/cache/go
      -e GOLANGCI_LINT_CACHE=/cache/go
      -w /app
      {{.Ref}}
      golangci-lint run --timeout 5m

  - id: build
    type: build
    dockerfile: Dockerfile
    opts:
      - name: bin_name
        desc: The name of the binary that also defines the build target as cmd/<bin_name>
        prompt: Please enter then name of the binary
        required: true
    cmd: >
      -f {{.Dockerfile}}
      --build-arg BIN_NAME={{opt "bin_name"}}
      --build-arg NO_ARCHIVE=true
      --platform local
      --target export-bin
      --output type=local,dest=dist/
      .

  - id: build:all
    type: build
    dockerfile: Dockerfile
    opts:
      - name: bin_name
        desc: The name of the binary that also defines the build target as cmd/<bin_name>
        prompt: Please enter then name of the binary
        required: true
      - name: platforms
        desc: "Comma separated list of platforms to build for (ex: linux/amd64,linux/arm64)"
        prompt: "Please enter the comma separated list of platforms (ex: linux/amd64,linux/arm64)"
    cmd: >
      -f {{.Dockerfile}}
      --build-arg BIN_NAME={{opt "bin_name"}}
      {{if opt "platforms"}}--platform {{opt "platforms"}}{{end}}
      --target export-bin
      --output type=local,dest=dist/,platform-split=false
      .

  - id: mocks
    type: run
    shell:
      pwd: pwd
      gopath: go env GOPATH
      gocache: go env GOCACHE
    cmd: >
      --rm
      -v {{sh "pwd"}}:/app
      -v {{sh "gopath"}}/pkg:/go/pkg
      -v {{sh "gocache"}}:/cache/go
      -e GOCACHE=/cache/go
      -v {{sh "pwd"}}:/src
      -w /src
      docker/mockery:v2.46
      --keeptree -r --all
